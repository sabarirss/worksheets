<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Practice Worksheets</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            position: relative;
        }

        .settings-header h1 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 2.5em;
        }

        .settings-header p {
            color: #666;
            margin: 0;
        }

        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: #666;
        }

        .close-btn:hover {
            background: #e0e0e0;
            color: #333;
            transform: rotate(90deg);
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .protected-field {
            position: relative;
        }

        .lock-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .parent-control-box {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }

        .parent-control-box h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .age-guidelines {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .age-guidelines h4 {
            color: #667eea;
            margin: 0 0 10px 0;
        }

        .age-guidelines ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .age-guidelines li {
            margin: 5px 0;
        }

        .module-badge {
            display: inline-block;
            margin: 5px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            background: #e3f2fd;
            color: #1976d2;
            font-weight: bold;
        }

        .module-badge.disabled {
            background: #fafafa;
            color: #999;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #f5c6cb;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Firebase Auth -->
    <script src="firebase-auth.js"></script>
    <script src="age-filter.js"></script>
</head>
<body>
    <div class="settings-container">
        <div class="settings-header">
            <button class="close-btn" onclick="window.location.href='index.html'" title="Close Settings">‚úï</button>
            <h1>‚öôÔ∏è Settings</h1>
            <p>Manage your profile and preferences</p>
        </div>

        <div class="success-message" id="success-message"></div>
        <div class="error-message" id="error-message"></div>

        <!-- Profile Information -->
        <div class="settings-section">
            <h2>üë§ Profile Information</h2>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" disabled>
                <div class="info-text">Username cannot be changed</div>
            </div>

            <div class="form-group">
                <label for="fullname">Full Name</label>
                <input type="text" id="fullname" placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" disabled>
                <div class="info-text">Email cannot be changed</div>
            </div>

            <div class="form-group">
                <label for="role">Account Type</label>
                <input type="text" id="role" disabled>
                <div class="info-text">Only admins can change account types</div>
            </div>

            <div class="form-group">
                <label for="version">Version</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="text" id="version" disabled style="flex: 1;">
                    <button id="request-upgrade-btn" class="btn" style="background: #4caf50; color: white; display: none; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onclick="requestVersionUpgrade()">
                        üì§ Request Full Version
                    </button>
                    <span id="upgrade-requested-badge" style="display: none; background: #ff9800; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold;">
                        ‚è≥ Upgrade Requested
                    </span>
                </div>
                <div class="info-text" id="version-info-text">Demo version limited to 2 pages per activity</div>
            </div>

            <!-- Admin Demo Preview Toggle -->
            <div class="form-group" id="admin-demo-preview" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-top: 20px;">
                <label style="display: flex; align-items: center; gap: 15px; cursor: pointer; font-size: 1.1em;">
                    <input type="checkbox" id="demo-preview-toggle" onchange="toggleDemoPreview(this.checked)"
                           style="width: 24px; height: 24px; cursor: pointer;">
                    <span>
                        <strong>üîç Preview Demo Mode</strong><br>
                        <span style="font-size: 0.9em; font-weight: normal; color: #666;">
                            Enable to see what demo users experience (2 items per activity)
                        </span>
                    </span>
                </label>
            </div>
        </div>

        <!-- Password Change Section -->
        <div class="settings-section">
            <h2>üîê Change Password</h2>

            <div class="parent-control-box">
                <h3>üîí Password Protected</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Password changes require parental verification to ensure account security.
                    Only parents/guardians can change the account password.
                </p>

                <button class="btn btn-primary" onclick="openPasswordChange()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    üîê Change Password (Parent Login Required)
                </button>

                <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                        <strong>Security Note:</strong> Requires parent verification before password can be changed.
                    </p>
                </div>
            </div>
        </div>

        <!-- Current Child Age Display -->
        <div class="settings-section">
            <h2>üë∂ Child's Current Age</h2>
            <div class="form-group">
                <label for="current-age-display">Age</label>
                <input type="text" id="current-age-display" disabled style="font-size: 1.1em; font-weight: bold; color: #667eea;">
            </div>
            <div style="margin-top: 20px;">
                <h4 style="color: #667eea; margin-bottom: 10px;">Currently Available Modules:</h4>
                <div id="modules-display"></div>
            </div>
        </div>

        <!-- Parental Control Section -->
        <div class="settings-section">
            <h2>üë®‚Äçüë©‚Äçüëß Parental Control</h2>

            <div class="parent-control-box">
                <h3>üîí Age Settings & Package Management</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Parents can manage their child's age settings and learning modules. This affects which content your child can access.
                    Requires parent verification.
                </p>

                <button class="btn btn-primary" onclick="openParentalControl()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    üîê Access Parental Control
                </button>

                <div class="age-guidelines" style="margin-top: 20px;">
                    <h4>Age-Appropriate Content:</h4>
                    <ul>
                        <li><strong>Ages 4-5:</strong> Basic counting, simple words, pattern recognition</li>
                        <li><strong>Age 6:</strong> Addition/subtraction to 20, sight words, simple stories</li>
                        <li><strong>Age 7:</strong> Two-digit math, sentences, synonyms, logic puzzles</li>
                        <li><strong>Age 8:</strong> Multiplication/division, grammar, reading comprehension, cursive writing</li>
                        <li><strong>Age 9+:</strong> Advanced math operations, advanced reading, complex reasoning</li>
                        <li><strong>Age 10+:</strong> Pre-algebra, essay writing, advanced problem-solving, German B1 (adult level)</li>
                    </ul>
                    <p style="font-size: 0.85em; color: #888; margin: 10px 0 0 0;">Note: Content difficulty automatically adjusts based on child's age</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                ‚Üê Back to Home
            </button>
            <button class="btn btn-primary" onclick="saveProfile()">
                üíæ Save Changes
            </button>
        </div>
    </div>

    <!-- Parent Age Verification Modal -->
    <div class="modal" id="parent-verification-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0; color: #667eea;">üîí Parent Verification</h2>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                To verify you are a parent/guardian, please enter your date of birth.
            </p>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Your Date of Birth:</label>
                <input
                    type="date"
                    id="parent-dob-input"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div id="parent-verification-error" style="color: #e74c3c; font-weight: bold; margin: 10px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="verifyParentAge()" class="btn btn-primary" style="flex: 1;">
                    Verify & Continue
                </button>
                <button onclick="closeParentVerification()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                    <strong>Privacy Note:</strong> Your date of birth is only used for age verification and is not stored.
                </p>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal" id="password-change-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0; color: #667eea;">üîê Change Password</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter your current password and choose a new one.</p>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Current Password:</label>
                <input
                    type="password"
                    id="modal-current-password"
                    placeholder="Enter your current password"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">New Password:</label>
                <input
                    type="password"
                    id="modal-new-password"
                    placeholder="Enter new password (min 6 characters)"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">Password must be at least 6 characters long</div>
            </div>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Confirm New Password:</label>
                <input
                    type="password"
                    id="modal-confirm-password"
                    placeholder="Confirm your new password"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div id="password-change-error" style="color: #e74c3c; font-weight: bold; margin: 10px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="saveNewPassword()" class="btn btn-primary" style="flex: 1;">
                    üíæ Save New Password
                </button>
                <button onclick="closePasswordChangeModal()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; font-size: 0.9em; color: #856404;">
                    <strong>Note:</strong> After changing the password, the user will need to log in again with the new password.
                </p>
            </div>
        </div>
    </div>

    <!-- Parental Control Panel Modal -->
    <div class="modal" id="parental-control-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-top: 0; color: #667eea;">üë®‚Äçüë©‚Äçüëß Parental Control Panel</h2>
            <p style="color: #666; margin-bottom: 30px;">Manage your child's age settings and learning modules.</p>

            <!-- Age Settings -->
            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-top: 0;">üë∂ Child's Age Settings</h3>
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Current Age:</label>
                    <input type="text" id="panel-current-age" disabled style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; font-weight: bold; color: #667eea; background: white; box-sizing: border-box;">
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Change Age To:</label>
                    <select id="panel-new-age" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;">
                        <option value="">Keep current age</option>
                        <option value="4">4 years old</option>
                        <option value="5">5 years old</option>
                        <option value="6">6 years old</option>
                        <option value="7">7 years old</option>
                        <option value="8">8 years old</option>
                        <option value="9">9 years old</option>
                        <option value="10">10 years old</option>
                        <option value="11">11 years old</option>
                        <option value="12">12 years old</option>
                        <option value="13">13+ years old</option>
                    </select>
                </div>
            </div>

            <!-- Package Management -->
            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-top: 0;">üìö Learning Packages</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">Enable or disable modules for your child:</p>
                <div style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-math" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìê Mathematics</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-english" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìö English</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-aptitude" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üß© Aptitude</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-stories" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìñ Stories</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-emotional-quotient" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">‚ù§Ô∏è Emotional Quotient</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-drawing" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üé® Drawing</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-german-kids" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üá©üá™ German Kids</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-learn-english-stories" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìö Learn English Stories</span>
                    </label>
                </div>
            </div>

            <div id="panel-error" style="color: #e74c3c; font-weight: bold; margin: 15px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="saveParentalControlChanges()" class="btn btn-primary" style="flex: 1;">
                    üíæ Save All Changes
                </button>
                <button onclick="closeParentalControlPanel()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let parentalVerificationAction = null; // Track what action requires verification

        // Wait for Firebase auth
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            await loadUserProfile();
        });

        async function loadUserProfile() {
            try {
                const firebaseUser = firebase.auth().currentUser;
                if (!firebaseUser) {
                    showError('Not authenticated');
                    return;
                }

                // Fetch user data from Firestore by email
                const userQuery = await firebase.firestore().collection('users')
                    .where('email', '==', firebaseUser.email.toLowerCase())
                    .limit(1)
                    .get();

                if (userQuery.empty) {
                    showError('User profile not found');
                    return;
                }

                const userDoc = userQuery.docs[0];
                const userData = userDoc.data();
                userData.uid = firebaseUser.uid; // Add UID for updates

                // Ensure enabledModules exists (initialize for existing users)
                if (!userData.enabledModules) {
                    console.log('Initializing enabledModules for existing user');
                    const enabledModules = {
                        math: true,  // Only math enabled by default
                        english: false,
                        aptitude: false,
                        stories: false,
                        'emotional-quotient': false,
                        german: false,
                        drawing: false,
                        'german-kids': false,
                        'learn-english-stories': false
                    };

                    try {
                        await firebase.firestore().collection('users').doc(firebaseUser.uid.substring(0, 20)).update({
                            enabledModules: enabledModules
                        });
                        userData.enabledModules = enabledModules;
                        console.log('enabledModules initialized');
                    } catch (error) {
                        console.error('Error initializing enabledModules:', error);
                    }
                }

                currentUser = userData;

                // Populate fields
                document.getElementById('username').value = userData.username || '';
                document.getElementById('fullname').value = userData.fullName || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('role').value = userData.role || 'student';

                // Display version and upgrade controls
                const version = userData.version || 'demo';
                const versionDisplay = version === 'demo' ? 'Demo (Limited)' : 'Full (Unlimited)';
                document.getElementById('version').value = versionDisplay;

                // Show/hide upgrade request button based on version and request status
                const requestBtn = document.getElementById('request-upgrade-btn');
                const requestedBadge = document.getElementById('upgrade-requested-badge');
                const versionInfoText = document.getElementById('version-info-text');

                if (version === 'demo') {
                    if (userData.versionUpgradeRequested) {
                        requestBtn.style.display = 'none';
                        requestedBadge.style.display = 'inline-block';
                        versionInfoText.textContent = 'Upgrade request pending admin approval';
                    } else {
                        requestBtn.style.display = 'inline-block';
                        requestedBadge.style.display = 'none';
                        versionInfoText.textContent = 'Demo version limited to 2 pages per activity';
                    }
                } else {
                    requestBtn.style.display = 'none';
                    requestedBadge.style.display = 'none';
                    versionInfoText.textContent = 'Full version with unlimited access';
                }

                // Show admin demo preview toggle for admin users
                if (userData.role === 'admin') {
                    document.getElementById('admin-demo-preview').style.display = 'block';

                    // Load and set current preview state
                    const isDemoPreview = localStorage.getItem('adminDemoPreview') === 'true';
                    document.getElementById('demo-preview-toggle').checked = isDemoPreview;
                }

                // Display current age
                const ageDisplay = userData.age ? `${userData.age} years old` : 'Not set';
                document.getElementById('current-age-display').value = ageDisplay;

                // Display enabled modules (what parent has enabled for child)
                displayModules(userData.enabledModules || {});
            } catch (error) {
                console.error('Error loading user profile:', error);
                showError('Failed to load user data: ' + error.message);
            }
        }

        function displayModules(modules) {
            const moduleNames = {
                math: 'üìê Mathematics',
                english: 'üìö English',
                aptitude: 'üß© Aptitude',
                stories: 'üìñ Stories',
                'emotional-quotient': '‚ù§Ô∏è Emotional Quotient',
                german: 'üá©üá™ German B1',
                drawing: 'üé® Drawing',
                'german-kids': 'üá©üá™ German Kids',
                'learn-english-stories': 'üìö Learn English Stories'
            };

            let html = '<div style="display: flex; flex-wrap: wrap;">';
            let enabledCount = 0;

            // Only show enabled modules
            for (const [key, enabled] of Object.entries(modules)) {
                if (enabled) {
                    const name = moduleNames[key] || key;
                    html += `<span class="module-badge">${name}</span>`;
                    enabledCount++;
                }
            }

            html += '</div>';

            if (enabledCount === 0) {
                html = '<p style="color: #999;">No modules enabled yet. Use Parental Control to enable modules.</p>';
            }

            document.getElementById('modules-display').innerHTML = html;
        }

        async function saveProfile() {
            if (!currentUser) return;

            const fullName = document.getElementById('fullname').value.trim();

            if (!fullName) {
                showError('Full name is required');
                return;
            }

            try {
                const userDoc = firebase.firestore().collection('users').doc(currentUser.uid.substring(0, 20));
                await userDoc.update({
                    fullName: fullName
                });

                // Update local cache
                currentUser.fullName = fullName;

                showSuccess('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Failed to update profile: ' + error.message);
            }
        }

        // Parental Control Functions
        function openParentalControl() {
            // Skip age verification for admin users
            if (currentUser && currentUser.role === 'admin') {
                openParentalControlPanel();
                return;
            }

            parentalVerificationAction = 'control'; // Set action type
            document.getElementById('parent-verification-modal').style.display = 'flex';
            document.getElementById('parent-dob-input').value = '';
            document.getElementById('parent-verification-error').style.display = 'none';

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('parent-dob-input').max = today;

            setTimeout(() => {
                document.getElementById('parent-dob-input').focus();
            }, 100);
        }

        function openPasswordChange() {
            // Skip age verification for admin users
            if (currentUser && currentUser.role === 'admin') {
                openPasswordChangeModal();
                return;
            }

            parentalVerificationAction = 'password'; // Set action type
            document.getElementById('parent-verification-modal').style.display = 'flex';
            document.getElementById('parent-dob-input').value = '';
            document.getElementById('parent-verification-error').style.display = 'none';

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('parent-dob-input').max = today;

            setTimeout(() => {
                document.getElementById('parent-dob-input').focus();
            }, 100);
        }

        function closeParentVerification() {
            document.getElementById('parent-verification-modal').style.display = 'none';
            parentalVerificationAction = null;
        }

        function verifyParentAge() {
            const dobInput = document.getElementById('parent-dob-input').value;
            const errorDiv = document.getElementById('parent-verification-error');

            if (!dobInput) {
                errorDiv.textContent = 'Please select your date of birth';
                errorDiv.style.display = 'block';
                return;
            }

            // Calculate age
            const dob = new Date(dobInput);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }

            // Check if age is 25 or more (internal check, don't expose age requirement)
            if (age < 25) {
                errorDiv.textContent = 'Parent verification failed. Please ensure you are entering the parent/guardian date of birth.';
                errorDiv.style.display = 'block';
                return;
            }

            // Age verified - route to appropriate action
            closeParentVerification();

            if (parentalVerificationAction === 'password') {
                openPasswordChangeModal();
            } else {
                openParentalControlPanel();
            }
        }

        function openParentalControlPanel() {
            document.getElementById('parental-control-panel').style.display = 'flex';
            document.getElementById('panel-error').style.display = 'none';

            // Load current age
            if (currentUser) {
                const ageDisplay = currentUser.age ? `${currentUser.age} years old` : 'Not set';
                document.getElementById('panel-current-age').value = ageDisplay;

                // Get assigned modules (what admin has made available)
                const assignedModules = currentUser.modules || {};
                // Get enabled modules (what parent has enabled) - fallback to modules if enabledModules doesn't exist
                const enabledModules = currentUser.enabledModules || currentUser.modules || {};

                // Package list
                const allModules = [
                    { key: 'math', id: 'panel-toggle-math' },
                    { key: 'english', id: 'panel-toggle-english' },
                    { key: 'aptitude', id: 'panel-toggle-aptitude' },
                    { key: 'stories', id: 'panel-toggle-stories' },
                    { key: 'emotional-quotient', id: 'panel-toggle-emotional-quotient' },
                    { key: 'drawing', id: 'panel-toggle-drawing' },
                    { key: 'german-kids', id: 'panel-toggle-german-kids' },
                    { key: 'learn-english-stories', id: 'panel-toggle-learn-english-stories' }
                ];

                // Update each module checkbox
                allModules.forEach(module => {
                    const checkbox = document.getElementById(module.id);
                    const label = checkbox.closest('label');

                    if (assignedModules[module.key]) {
                        // Package is assigned by admin - show and enable it
                        label.style.display = 'flex';
                        checkbox.disabled = false;
                        checkbox.checked = enabledModules[module.key] || false;
                    } else {
                        // Package not assigned by admin - hide it
                        label.style.display = 'none';
                    }
                });
            }
        }

        function closeParentalControlPanel() {
            document.getElementById('parental-control-panel').style.display = 'none';
        }

        async function saveParentalControlChanges() {
            if (!currentUser) return;

            const errorDiv = document.getElementById('panel-error');
            const newAge = document.getElementById('panel-new-age').value;

            try {
                const userDoc = firebase.firestore().collection('users').doc(currentUser.uid.substring(0, 20));
                const updates = {};

                // Update age if changed
                if (newAge) {
                    updates.age = parseInt(newAge);
                    currentUser.age = parseInt(newAge);
                }

                // Update enabled modules (parent controls these)
                const enabledModules = {
                    math: document.getElementById('panel-toggle-math').checked,
                    english: document.getElementById('panel-toggle-english').checked,
                    aptitude: document.getElementById('panel-toggle-aptitude').checked,
                    stories: document.getElementById('panel-toggle-stories').checked,
                    'emotional-quotient': document.getElementById('panel-toggle-emotional-quotient').checked,
                    drawing: document.getElementById('panel-toggle-drawing').checked,
                    'german-kids': document.getElementById('panel-toggle-german-kids').checked,
                    'learn-english-stories': document.getElementById('panel-toggle-learn-english-stories').checked
                };

                // Add enabled module updates
                for (const [key, value] of Object.entries(enabledModules)) {
                    updates[`enabledModules.${key}`] = value;
                }

                // Save to Firestore
                await userDoc.update(updates);

                // Update local cache
                currentUser.enabledModules = enabledModules;

                closeParentalControlPanel();
                showSuccess('Settings updated successfully! Page will reload to apply changes.');

                // Reload after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Error saving parental control changes:', error);
                errorDiv.textContent = 'Failed to save changes: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';

            // Hide error message
            document.getElementById('error-message').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Hide success message
            document.getElementById('success-message').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Request version upgrade
        async function requestVersionUpgrade() {
            if (!currentUser) return;

            if (!confirm('Request full version upgrade? An admin will review your request.')) {
                return;
            }

            try {
                const uid = currentUser.uid.substring(0, 20);
                await firebase.firestore().collection('users').doc(uid).update({
                    versionUpgradeRequested: true,
                    upgradeRequestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSuccess('Full version upgrade requested! An admin will review your request.');

                // Reload profile to update UI
                await loadUserProfile();
            } catch (error) {
                console.error('Error requesting upgrade:', error);
                showError('Failed to request upgrade: ' + error.message);
            }
        }

        // Toggle admin demo preview mode
        function toggleDemoPreview(isEnabled) {
            localStorage.setItem('adminDemoPreview', isEnabled ? 'true' : 'false');

            if (isEnabled) {
                showSuccess('Demo Preview Mode Enabled - You will now see the demo experience (2 items per activity). Return to this page to disable.');
            } else {
                showSuccess('Demo Preview Mode Disabled - Full access restored.');
            }

            // Redirect to home page after short delay
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        // Password change modal functions
        function openPasswordChangeModal() {
            document.getElementById('password-change-modal').style.display = 'flex';
            document.getElementById('modal-current-password').value = '';
            document.getElementById('modal-new-password').value = '';
            document.getElementById('modal-confirm-password').value = '';
            document.getElementById('password-change-error').style.display = 'none';

            setTimeout(() => {
                document.getElementById('modal-current-password').focus();
            }, 100);
        }

        function closePasswordChangeModal() {
            document.getElementById('password-change-modal').style.display = 'none';
        }

        async function saveNewPassword() {
            const currentPassword = document.getElementById('modal-current-password').value.trim();
            const newPassword = document.getElementById('modal-new-password').value.trim();
            const confirmPassword = document.getElementById('modal-confirm-password').value.trim();
            const errorDiv = document.getElementById('password-change-error');

            // Validation
            if (!currentPassword) {
                errorDiv.textContent = 'Please enter your current password';
                errorDiv.style.display = 'block';
                return;
            }

            if (!newPassword) {
                errorDiv.textContent = 'Please enter a new password';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long';
                errorDiv.style.display = 'block';
                return;
            }

            if (!confirmPassword) {
                errorDiv.textContent = 'Please confirm your new password';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (currentPassword === newPassword) {
                errorDiv.textContent = 'New password must be different from current password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    errorDiv.textContent = 'User not authenticated';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Re-authenticate user with current password (required by Firebase)
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );

                await user.reauthenticateWithCredential(credential);

                // Now update password
                await user.updatePassword(newPassword);

                closePasswordChangeModal();
                showSuccess('Password changed successfully! Please log in again with the new password.');

                // Sign out after 2 seconds to require new login
                setTimeout(() => {
                    firebase.auth().signOut().then(() => {
                        window.location.href = 'login.html';
                    });
                }, 2000);
            } catch (error) {
                console.error('Error changing password:', error);

                let errorMessage = 'Failed to change password: ';

                if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please log out and log back in';
                } else {
                    errorMessage += error.message;
                }

                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        }

        // Add Enter key support for password modal fields
        document.addEventListener('DOMContentLoaded', function() {
            const passwordFields = ['modal-new-password', 'modal-confirm-password'];

            passwordFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            saveNewPassword();
                        }
                    });
                }
            });
        });

        // Close modals on background click
        document.getElementById('parent-verification-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeParentVerification();
            }
        });

        document.getElementById('parental-control-panel').addEventListener('click', function(event) {
            if (event.target === this) {
                closeParentalControlPanel();
            }
        });

        document.getElementById('password-change-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closePasswordChangeModal();
            }
        });
    </script>
</body>
</html>
