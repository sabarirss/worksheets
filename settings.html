<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Practice Worksheets</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            position: relative;
        }

        .settings-header h1 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 2.5em;
        }

        .settings-header p {
            color: #666;
            margin: 0;
        }

        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: #666;
        }

        .close-btn:hover {
            background: #e0e0e0;
            color: #333;
            transform: rotate(90deg);
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .protected-field {
            position: relative;
        }

        .lock-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .parent-control-box {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }

        .parent-control-box h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .age-guidelines {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .age-guidelines h4 {
            color: #667eea;
            margin: 0 0 10px 0;
        }

        .age-guidelines ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .age-guidelines li {
            margin: 5px 0;
        }

        .module-badge {
            display: inline-block;
            margin: 5px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            background: #e3f2fd;
            color: #1976d2;
            font-weight: bold;
        }

        .module-badge.disabled {
            background: #fafafa;
            color: #999;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #f5c6cb;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Firebase Auth -->
    <script src="firebase-auth.js"></script>
    <script src="age-filter.js"></script>
</head>
<body>
    <div class="settings-container">
        <div class="settings-header">
            <button class="close-btn" onclick="window.location.href='index.html'" title="Close Settings">‚úï</button>
            <h1>‚öôÔ∏è Settings</h1>
            <p>Manage your profile and preferences</p>
        </div>

        <div class="success-message" id="success-message"></div>
        <div class="error-message" id="error-message"></div>

        <!-- Profile Information -->
        <div class="settings-section">
            <h2>üë§ Profile Information</h2>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" disabled>
                <div class="info-text">Username cannot be changed</div>
            </div>

            <div class="form-group">
                <label for="fullname">Full Name</label>
                <input type="text" id="fullname" placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" disabled>
                <div class="info-text">Email cannot be changed</div>
            </div>

            <div class="form-group">
                <label for="role">Account Type</label>
                <input type="text" id="role" disabled>
                <div class="info-text">Only admins can change account types</div>
            </div>


            <!-- Input Mode Selection -->
            <div class="form-group" id="input-mode-section">
                <label for="input-mode">‚úçÔ∏è Input Mode</label>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; padding: 15px 25px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; background: white; flex: 1; transition: all 0.3s;" id="keyboard-label">
                        <input type="radio" name="inputMode" value="keyboard" id="input-mode-keyboard" onchange="updateInputMode('keyboard')" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-size: 1.1em;">‚å®Ô∏è Keyboard</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px 25px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; background: white; flex: 1; transition: all 0.3s;" id="stylus-label">
                        <input type="radio" name="inputMode" value="pencil" id="input-mode-pencil" onchange="updateInputMode('pencil')" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-size: 1.1em;">‚úèÔ∏è Stylus</span>
                        <span id="stylus-full-version-badge" style="font-size: 0.8em; color: #ff9800; margin-left: 8px; display: none;">(Full Version)</span>
                    </label>
                </div>
                <div class="info-text">Select how you want to input answers in worksheets</div>
            </div>

            <!-- Admin Demo Preview Toggle -->
            <div class="form-group" id="admin-demo-preview" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-top: 20px;">
                <label style="display: flex; align-items: center; gap: 15px; cursor: pointer; font-size: 1.1em;">
                    <input type="checkbox" id="demo-preview-toggle" onchange="toggleDemoPreview(this.checked)"
                           style="width: 24px; height: 24px; cursor: pointer;">
                    <span>
                        <strong>üîç Preview Demo Mode</strong><br>
                        <span style="font-size: 0.9em; font-weight: normal; color: #666;">
                            Enable to see what demo users experience (2 items per activity)
                        </span>
                    </span>
                </label>
            </div>
        </div>

        <!-- Password Change Section -->
        <div class="settings-section">
            <h2>üîê Change Password</h2>

            <div class="parent-control-box">
                <h3>üîí Password Protected</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Password changes require parental verification to ensure account security.
                    Only parents/guardians can change the account password.
                </p>

                <button class="btn btn-primary" onclick="openPasswordChange()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    üîê Change Password (Parent Login Required)
                </button>

                <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                        <strong>Security Note:</strong> Requires parent verification before password can be changed.
                    </p>
                </div>
            </div>
        </div>

        <!-- Parental Control Section (Hidden for Admin) -->
        <div class="settings-section" id="parental-control-section">
            <h2>üë®‚Äçüë©‚Äçüëß Parental Control</h2>

            <div class="parent-control-box">
                <h3>üîí Package Management</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Parents can manage learning modules for each child profile. Enable or disable packages to control which content your children can access.
                    Requires parent verification.
                </p>

                <button class="btn btn-primary" onclick="openParentalControl()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    üîê Manage Child Packages
                </button>
            </div>

            <!-- Children Version Management -->
            <div id="children-version-section" style="margin-top: 30px;">
                <h3>üì¶ Version Management (Per Child)</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Manage version and upgrade requests for each child individually.
                </p>
                <div id="children-version-list">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                ‚Üê Back to Home
            </button>
            <button class="btn btn-primary" onclick="saveProfile()">
                üíæ Save Changes
            </button>
        </div>
    </div>

    <!-- Parent Age Verification Modal -->
    <div class="modal" id="parent-verification-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0; color: #667eea;">üîí Parent Verification</h2>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                To verify you are a parent/guardian, please enter your date of birth.
            </p>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Your Date of Birth:</label>
                <input
                    type="date"
                    id="parent-dob-input"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div id="parent-verification-error" style="color: #e74c3c; font-weight: bold; margin: 10px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="verifyParentAge()" class="btn btn-primary" style="flex: 1;">
                    Verify & Continue
                </button>
                <button onclick="closeParentVerification()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                <p style="margin: 0; font-size: 0.9em; color: #2e7d32;">
                    <strong>Privacy Note:</strong> Your date of birth is only used for age verification and is not stored.
                </p>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal" id="password-change-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;">
            <h2 style="margin-top: 0; color: #667eea;">üîê Change Password</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter your current password and choose a new one.</p>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Current Password:</label>
                <input
                    type="password"
                    id="modal-current-password"
                    placeholder="Enter your current password"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">New Password:</label>
                <input
                    type="password"
                    id="modal-new-password"
                    placeholder="Enter new password (min 6 characters)"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">Password must be at least 6 characters long</div>
            </div>

            <div style="margin: 20px 0;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">Confirm New Password:</label>
                <input
                    type="password"
                    id="modal-confirm-password"
                    placeholder="Confirm your new password"
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;"
                >
            </div>

            <div id="password-change-error" style="color: #e74c3c; font-weight: bold; margin: 10px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="saveNewPassword()" class="btn btn-primary" style="flex: 1;">
                    üíæ Save New Password
                </button>
                <button onclick="closePasswordChangeModal()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; font-size: 0.9em; color: #856404;">
                    <strong>Note:</strong> After changing the password, the user will need to log in again with the new password.
                </p>
            </div>
        </div>
    </div>

    <!-- Parental Control Panel Modal -->
    <div class="modal" id="parental-control-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-top: 0; color: #667eea;">üë®‚Äçüë©‚Äçüëß Manage Child Packages</h2>
            <p style="color: #666; margin-bottom: 30px;">Select a child to manage their learning modules.</p>

            <!-- Child Selection -->
            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                <h3 style="color: #667eea; margin-top: 0;">üë∂ Select Child</h3>
                <div style="margin: 15px 0;">
                    <select id="panel-child-select" onchange="loadChildPackages()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;">
                        <option value="">-- Select a child --</option>
                    </select>
                </div>
                <div id="child-age-display" style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; display: none;">
                    <strong>Age:</strong> <span id="child-age-value" style="color: #667eea; font-weight: bold;"></span>
                    <span style="color: #888; font-size: 0.9em; margin-left: 10px;">(calculated from date of birth)</span>
                </div>
            </div>

            <!-- Package Management -->
            <div id="package-management-section" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; display: none;">
                <h3 style="color: #667eea; margin-top: 0;">üìö Learning Packages</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">Enable or disable modules for <strong id="selected-child-name"></strong>:</p>
                <div style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-math" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìê Mathematics</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-english" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìö English</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-aptitude" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üß© Aptitude</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-stories" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üìñ Stories</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-emotional-quotient" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">‚ù§Ô∏è Emotional Quotient</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-drawing" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üé® Drawing</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="checkbox" id="panel-toggle-german-kids" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <span style="font-size: 1.05em;">üá©üá™ German Kids</span>
                    </label>
                </div>
            </div>

            <div id="panel-error" style="color: #e74c3c; font-weight: bold; margin: 15px 0; display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="saveChildPackages()" class="btn btn-primary" style="flex: 1;" id="save-packages-btn" disabled>
                    üíæ Save Changes
                </button>
                <button onclick="closeParentalControlPanel()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let parentalVerificationAction = null; // Track what action requires verification

        // Update input mode for current selected child or admin
        async function updateInputMode(mode) {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    showError('Not authenticated');
                    return;
                }

                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const isAdmin = userData && userData.role === 'admin';

                if (isAdmin) {
                    // Admin: save to their own profile
                    await firebase.firestore().collection('users').doc(user.uid).update({
                        inputMode: mode,
                        updated_at: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const modeIcon = mode === 'keyboard' ? '‚å®Ô∏è' : '‚úèÔ∏è';
                    const modeName = mode === 'keyboard' ? 'Keyboard' : 'Stylus';
                    showSuccess(`Input mode changed to ${modeIcon} ${modeName}`);
                    updateInputModeUI(mode);
                } else {
                    // Non-admin: get selected child and update their profile
                    const child = getSelectedChild();
                    if (!child) {
                        showError('No child selected. Please select a child profile first.');
                        return;
                    }

                    // Fetch full child data from Firestore to check version
                    const childDoc = await firebase.firestore().collection('children').doc(child.id).get();
                    if (!childDoc.exists) {
                        showError('Child profile not found');
                        return;
                    }

                    const childData = childDoc.data();

                    // Check if pencil mode is allowed
                    if (mode === 'pencil' && childData.version !== 'full') {
                        showError(`‚ú® Pencil Mode requires Full Version! ${child.name} has ${childData.version || 'demo'} version.`);

                        // Reset radio button to keyboard
                        document.getElementById('input-mode-keyboard').checked = true;
                        updateInputModeUI('keyboard');
                        return;
                    }

                    // Save to child's Firestore document
                    await firebase.firestore().collection('children').doc(child.id).update({
                        inputMode: mode,
                        updated_at: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const modeIcon = mode === 'keyboard' ? '‚å®Ô∏è' : '‚úèÔ∏è';
                    const modeName = mode === 'keyboard' ? 'Keyboard' : 'Stylus';
                    showSuccess(`Input mode for ${child.name} changed to ${modeIcon} ${modeName}`);
                    updateInputModeUI(mode);
                }
            } catch (error) {
                console.error('Error updating input mode:', error);
                showError('Failed to update input mode: ' + error.message);
            }
        }

        // Update input mode UI to reflect current selection
        function updateInputModeUI(mode) {
            const keyboardLabel = document.getElementById('keyboard-label');
            const stylusLabel = document.getElementById('stylus-label');
            const keyboardInput = document.getElementById('input-mode-keyboard');
            const stylusInput = document.getElementById('input-mode-pencil');

            if (mode === 'keyboard') {
                keyboardLabel.style.borderColor = '#667eea';
                keyboardLabel.style.background = '#f0f4ff';
                stylusLabel.style.borderColor = '#e0e0e0';
                stylusLabel.style.background = 'white';
                keyboardInput.checked = true;
            } else {
                keyboardLabel.style.borderColor = '#e0e0e0';
                keyboardLabel.style.background = 'white';
                stylusLabel.style.borderColor = '#667eea';
                stylusLabel.style.background = '#f0f4ff';
                stylusInput.checked = true;
            }
        }

        // Wait for Firebase auth
        firebase.auth().onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            await loadUserProfile();
        });

        async function loadUserProfile() {
            try {
                const firebaseUser = firebase.auth().currentUser;
                if (!firebaseUser) {
                    showError('Not authenticated');
                    return;
                }

                // Fetch user data from Firestore by email
                const userQuery = await firebase.firestore().collection('users')
                    .where('email', '==', firebaseUser.email.toLowerCase())
                    .limit(1)
                    .get();

                if (userQuery.empty) {
                    showError('User profile not found');
                    return;
                }

                const userDoc = userQuery.docs[0];
                const userData = userDoc.data();
                userData.uid = firebaseUser.uid; // Add UID for updates

                // Ensure enabledModules exists (initialize for existing users)
                if (!userData.enabledModules) {
                    console.log('Initializing enabledModules for existing user');
                    const enabledModules = {
                        math: true,  // Only math enabled by default
                        english: false,
                        aptitude: false,
                        stories: false,
                        'emotional-quotient': false,
                        german: false,
                        drawing: false,
                        'german-kids': false,
                        'learn-english-stories': false
                    };

                    try {
                        await firebase.firestore().collection('users').doc(firebaseUser.uid).update({
                            enabledModules: enabledModules
                        });
                        userData.enabledModules = enabledModules;
                        console.log('enabledModules initialized');
                    } catch (error) {
                        console.error('Error initializing enabledModules:', error);
                    }
                }

                currentUser = userData;

                // Populate fields
                document.getElementById('username').value = userData.username || '';
                document.getElementById('fullname').value = userData.fullName || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('role').value = userData.role || 'student';

                // Load children version information
                await loadChildrenVersionInfo();

                // Show admin demo preview toggle for admin users
                if (userData.role === 'admin') {
                    document.getElementById('admin-demo-preview').style.display = 'block';

                    // Load and set current preview state
                    const isDemoPreview = localStorage.getItem('adminDemoPreview') === 'true';
                    document.getElementById('demo-preview-toggle').checked = isDemoPreview;
                }

                // Input mode section: Show for admin only, hide for parents (they manage per-child)
                const inputModeSection = document.getElementById('input-mode-section');
                if (inputModeSection) {
                    if (userData.role === 'admin') {
                        inputModeSection.style.display = 'block';
                    } else {
                        inputModeSection.style.display = 'none';
                    }
                }

                // Hide Parental Control section for admin users
                if (userData.role === 'admin') {
                    const parentalControlSection = document.getElementById('parental-control-section');
                    if (parentalControlSection) {
                        parentalControlSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                showError('Failed to load user data: ' + error.message);
            }
        }

        function displayModules(modules) {
            const moduleNames = {
                math: 'üìê Mathematics',
                english: 'üìö English',
                aptitude: 'üß© Aptitude',
                stories: 'üìñ Stories',
                'emotional-quotient': '‚ù§Ô∏è Emotional Quotient',
                german: 'üá©üá™ German B1',
                drawing: 'üé® Drawing',
                'german-kids': 'üá©üá™ German Kids',
                'learn-english-stories': 'üìö Learn English Stories'
            };

            let html = '<div style="display: flex; flex-wrap: wrap;">';
            let enabledCount = 0;

            // Only show enabled modules
            for (const [key, enabled] of Object.entries(modules)) {
                if (enabled) {
                    const name = moduleNames[key] || key;
                    html += `<span class="module-badge">${name}</span>`;
                    enabledCount++;
                }
            }

            html += '</div>';

            if (enabledCount === 0) {
                html = '<p style="color: #999;">No modules enabled yet. Use Parental Control to enable modules.</p>';
            }

            document.getElementById('modules-display').innerHTML = html;
        }

        async function saveProfile() {
            if (!currentUser) return;

            const fullName = document.getElementById('fullname').value.trim();

            if (!fullName) {
                showError('Full name is required');
                return;
            }

            try {
                const userDoc = firebase.firestore().collection('users').doc(currentUser.uid);
                await userDoc.update({
                    fullName: fullName
                });

                // Update local cache
                currentUser.fullName = fullName;

                showSuccess('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Failed to update profile: ' + error.message);
            }
        }

        // Parental Control Functions
        function openParentalControl() {
            // Skip age verification for admin users
            if (currentUser && currentUser.role === 'admin') {
                openParentalControlPanel();
                return;
            }

            parentalVerificationAction = 'control'; // Set action type
            document.getElementById('parent-verification-modal').style.display = 'flex';
            document.getElementById('parent-dob-input').value = '';
            document.getElementById('parent-verification-error').style.display = 'none';

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('parent-dob-input').max = today;

            setTimeout(() => {
                document.getElementById('parent-dob-input').focus();
            }, 100);
        }

        function openPasswordChange() {
            // Skip age verification for admin users
            if (currentUser && currentUser.role === 'admin') {
                openPasswordChangeModal();
                return;
            }

            parentalVerificationAction = 'password'; // Set action type
            document.getElementById('parent-verification-modal').style.display = 'flex';
            document.getElementById('parent-dob-input').value = '';
            document.getElementById('parent-verification-error').style.display = 'none';

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('parent-dob-input').max = today;

            setTimeout(() => {
                document.getElementById('parent-dob-input').focus();
            }, 100);
        }

        function closeParentVerification() {
            document.getElementById('parent-verification-modal').style.display = 'none';
            parentalVerificationAction = null;
        }

        function verifyParentAge() {
            const dobInput = document.getElementById('parent-dob-input').value;
            const errorDiv = document.getElementById('parent-verification-error');

            if (!dobInput) {
                errorDiv.textContent = 'Please select your date of birth';
                errorDiv.style.display = 'block';
                return;
            }

            // Calculate age
            const dob = new Date(dobInput);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }

            // Check if age is 25 or more (internal check, don't expose age requirement)
            if (age < 25) {
                errorDiv.textContent = 'Parent verification failed. Please ensure you are entering the parent/guardian date of birth.';
                errorDiv.style.display = 'block';
                return;
            }

            // Age verified - route to appropriate action
            closeParentVerification();

            if (parentalVerificationAction === 'password') {
                openPasswordChangeModal();
            } else {
                openParentalControlPanel();
            }
        }

        async function openParentalControlPanel() {
            document.getElementById('parental-control-panel').style.display = 'flex';
            document.getElementById('panel-error').style.display = 'none';
            document.getElementById('package-management-section').style.display = 'none';
            document.getElementById('save-packages-btn').disabled = true;

            // Load children list
            if (currentUser) {
                const childSelect = document.getElementById('panel-child-select');
                childSelect.innerHTML = '<option value="">-- Select a child --</option>';

                try {
                    const snapshot = await firebase.firestore()
                        .collection('children')
                        .where('parent_uid', '==', currentUser.uid)
                        .get();

                    if (snapshot.empty) {
                        childSelect.innerHTML = '<option value="">No children profiles found</option>';
                        return;
                    }

                    // Sort children by created_at in JavaScript
                    const children = [];
                    snapshot.forEach(doc => {
                        children.push({ id: doc.id, ...doc.data() });
                    });
                    children.sort((a, b) => {
                        const aTime = a.created_at ? a.created_at.toMillis() : 0;
                        const bTime = b.created_at ? b.created_at.toMillis() : 0;
                        return bTime - aTime; // descending order
                    });

                    children.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child.id;
                        option.textContent = child.name;
                        childSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading children:', error);
                    childSelect.innerHTML = '<option value="">Error loading children</option>';
                }
            }
        }

        async function loadChildPackages() {
            const childId = document.getElementById('panel-child-select').value;

            if (!childId) {
                document.getElementById('package-management-section').style.display = 'none';
                document.getElementById('child-age-display').style.display = 'none';
                document.getElementById('save-packages-btn').disabled = true;
                return;
            }

            try {
                const doc = await firebase.firestore().collection('children').doc(childId).get();

                if (!doc.exists) {
                    alert('Child not found');
                    return;
                }

                const child = doc.data();

                // Show child's age (calculated from DOB)
                document.getElementById('child-age-value').textContent = `${child.age} years old`;
                document.getElementById('child-age-display').style.display = 'block';
                document.getElementById('selected-child-name').textContent = child.name;

                // Show package management section
                document.getElementById('package-management-section').style.display = 'block';
                document.getElementById('save-packages-btn').disabled = false;

                // Get ASSIGNED modules (what admin made available)
                const assignedModules = child.assignedModules || child.modules || { math: true };

                // Get ENABLED modules (what parent has enabled)
                const enabledModules = child.enabledModules || { math: true };

                // Configure each module checkbox based on assigned status
                configureModuleCheckbox('panel-toggle-math', assignedModules.math, enabledModules.math, 'üìê Mathematics');
                configureModuleCheckbox('panel-toggle-english', assignedModules.english, enabledModules.english, 'üìö English');
                configureModuleCheckbox('panel-toggle-aptitude', assignedModules.aptitude, enabledModules.aptitude, 'üß© Aptitude');
                configureModuleCheckbox('panel-toggle-stories', assignedModules.stories, enabledModules.stories, 'üìñ Stories');
                configureModuleCheckbox('panel-toggle-emotional-quotient', assignedModules['emotional-quotient'], enabledModules['emotional-quotient'], '‚ù§Ô∏è Emotional Quotient');
                configureModuleCheckbox('panel-toggle-drawing', assignedModules.drawing, enabledModules.drawing, 'üé® Drawing');
                configureModuleCheckbox('panel-toggle-german-kids', assignedModules['german-kids'], enabledModules['german-kids'], 'üá©üá™ German Kids');

            } catch (error) {
                console.error('Error loading child packages:', error);
                alert('Error loading child data: ' + error.message);
            }
        }

        // Configure a module checkbox based on whether it's assigned and enabled
        function configureModuleCheckbox(checkboxId, isAssigned, isEnabled, moduleName) {
            const checkbox = document.getElementById(checkboxId);
            const label = checkbox.parentElement;

            // Remove any existing buy button
            const existingBtn = label.querySelector('.buy-btn');
            if (existingBtn) {
                existingBtn.remove();
            }

            if (!isAssigned) {
                // Module NOT assigned by admin - disable checkbox and show "Buy" button
                checkbox.checked = false;
                checkbox.disabled = true;
                label.style.opacity = '1';
                label.style.cursor = 'default';
                label.style.justifyContent = 'space-between';

                // Update label to show module name (without extra text)
                label.querySelector('span').textContent = moduleName;
                label.style.background = '#f5f5f5';
                label.style.borderColor = '#ddd';

                // Add "Buy" button
                const buyBtn = document.createElement('button');
                buyBtn.className = 'buy-btn';
                buyBtn.textContent = 'üõí Buy';
                buyBtn.style.cssText = `
                    padding: 8px 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.9em;
                    font-weight: bold;
                    transition: all 0.3s;
                    margin-left: auto;
                `;
                buyBtn.onmouseover = function() {
                    this.style.opacity = '0.9';
                    this.style.transform = 'scale(1.05)';
                };
                buyBtn.onmouseout = function() {
                    this.style.opacity = '1';
                    this.style.transform = 'scale(1)';
                };
                buyBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Non-functional for now
                    alert('Purchase functionality coming soon!');
                };

                label.appendChild(buyBtn);
            } else {
                // Module IS assigned - enable checkbox and set current enabled state
                checkbox.checked = isEnabled || false;
                checkbox.disabled = false;
                label.style.opacity = '1';
                label.style.cursor = 'pointer';
                label.style.justifyContent = 'flex-start';
                label.querySelector('span').textContent = moduleName;
                label.style.background = 'white';
                label.style.borderColor = '#e0e0e0';
            }
        }

        function closeParentalControlPanel() {
            document.getElementById('parental-control-panel').style.display = 'none';
        }

        async function saveChildPackages() {
            const childId = document.getElementById('panel-child-select').value;

            if (!childId) {
                alert('Please select a child first');
                return;
            }

            const errorDiv = document.getElementById('panel-error');

            try {
                // Collect enabled modules (only from non-disabled checkboxes)
                const enabledModules = {
                    math: document.getElementById('panel-toggle-math').disabled ? false : document.getElementById('panel-toggle-math').checked,
                    english: document.getElementById('panel-toggle-english').disabled ? false : document.getElementById('panel-toggle-english').checked,
                    aptitude: document.getElementById('panel-toggle-aptitude').disabled ? false : document.getElementById('panel-toggle-aptitude').checked,
                    stories: document.getElementById('panel-toggle-stories').disabled ? false : document.getElementById('panel-toggle-stories').checked,
                    'emotional-quotient': document.getElementById('panel-toggle-emotional-quotient').disabled ? false : document.getElementById('panel-toggle-emotional-quotient').checked,
                    drawing: document.getElementById('panel-toggle-drawing').disabled ? false : document.getElementById('panel-toggle-drawing').checked,
                    german: false, // German B1 is admin-only
                    'german-kids': document.getElementById('panel-toggle-german-kids').disabled ? false : document.getElementById('panel-toggle-german-kids').checked
                };

                console.log('Saving enabled modules (parent control):', enabledModules);

                // Save ONLY enabledModules (parent control)
                // Do NOT modify assignedModules (that's admin-only)
                await firebase.firestore().collection('children').doc(childId).update({
                    enabledModules: enabledModules,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeParentalControlPanel();
                showSuccess('‚úì Package settings updated successfully!\n\nModules will appear based on both admin assignment and your enabled settings.');

                // Reload after 2 seconds if this is the currently selected child
                const selectedChild = typeof getSelectedChild === 'function' ? getSelectedChild() : null;
                if (selectedChild && selectedChild.id === childId) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error saving child packages:', error);
                errorDiv.textContent = 'Failed to save changes: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';

            // Hide error message
            document.getElementById('error-message').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Hide success message
            document.getElementById('success-message').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load children version information
        async function loadChildrenVersionInfo() {
            if (!currentUser) return;

            const versionSection = document.getElementById('children-version-section');
            const versionList = document.getElementById('children-version-list');

            // Hide for admin
            if (currentUser.role === 'admin') {
                versionSection.style.display = 'none';
                return;
            }

            try {
                const snapshot = await firebase.firestore()
                    .collection('children')
                    .where('parent_uid', '==', currentUser.uid)
                    .get();

                if (snapshot.empty) {
                    versionList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No children profiles yet. Add children to manage their versions.</p>';
                    return;
                }

                versionList.innerHTML = '';

                snapshot.forEach(doc => {
                    const child = doc.data();
                    const childId = doc.id;
                    const version = child.version || 'demo';
                    const versionUpgradeRequested = child.versionUpgradeRequested || false;

                    const childCard = document.createElement('div');
                    childCard.style.cssText = `
                        background: #f8f9fa;
                        border: 2px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 15px;
                    `;

                    const versionBadge = version === 'full'
                        ? '<span style="background: #4caf50; color: white; padding: 6px 14px; border-radius: 15px; font-size: 0.9em; font-weight: bold;">‚ú® Full Version</span>'
                        : '<span style="background: #ff9800; color: white; padding: 6px 14px; border-radius: 15px; font-size: 0.9em; font-weight: bold;">üì¶ Demo Version</span>';

                    let actionButton = '';
                    if (version === 'demo') {
                        if (versionUpgradeRequested) {
                            actionButton = '<span style="background: #ff9800; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold;">‚è≥ Upgrade Requested</span>';
                        } else {
                            actionButton = `<button onclick="requestChildVersionUpgrade('${childId}', '${child.name}')" style="background: #4caf50; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">üõí Buy Full Version</button>`;
                        }
                    }

                    // Input mode is managed in Child Profile Settings section, not here

                    childCard.innerHTML = `
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1.2em;">
                                        ${child.gender === 'boy' ? 'üë¶' : child.gender === 'girl' ? 'üëß' : 'üë∂'} ${child.name}
                                    </h4>
                                    <div style="margin-bottom: 8px;">${versionBadge}</div>
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                        ${version === 'demo' ? 'Limited to 2 pages per activity' : 'Unlimited access to all content'}
                                    </p>
                                </div>
                                <div>
                                    ${actionButton}
                                </div>
                            </div>
                        </div>
                    `;

                    versionList.appendChild(childCard);
                });

            } catch (error) {
                console.error('Error loading children version info:', error);
                versionList.innerHTML = '<p style="color: #e74c3c;">Error loading children information</p>';
            }
        }

        // Request version upgrade for specific child
        async function requestChildVersionUpgrade(childId, childName) {
            if (!confirm(`Request full version upgrade for ${childName}?\n\nAn admin will review your request.`)) {
                return;
            }

            try {
                await firebase.firestore().collection('children').doc(childId).update({
                    versionUpgradeRequested: true,
                    upgradeRequestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSuccess(`Full version upgrade requested for ${childName}! An admin will review your request.`);

                // Reload children version info
                await loadChildrenVersionInfo();
            } catch (error) {
                console.error('Error requesting upgrade:', error);
                showError('Failed to request upgrade: ' + error.message);
            }
        }

        // Toggle admin demo preview mode
        function toggleDemoPreview(isEnabled) {
            localStorage.setItem('adminDemoPreview', isEnabled ? 'true' : 'false');

            if (isEnabled) {
                showSuccess('Demo Preview Mode Enabled - You will now see the demo experience (2 items per activity). Return to this page to disable.');
            } else {
                showSuccess('Demo Preview Mode Disabled - Full access restored.');
            }

            // Redirect to home page after short delay
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        // Input mode is now managed per-child in the generators, not here

        // Password change modal functions
        function openPasswordChangeModal() {
            document.getElementById('password-change-modal').style.display = 'flex';
            document.getElementById('modal-current-password').value = '';
            document.getElementById('modal-new-password').value = '';
            document.getElementById('modal-confirm-password').value = '';
            document.getElementById('password-change-error').style.display = 'none';

            setTimeout(() => {
                document.getElementById('modal-current-password').focus();
            }, 100);
        }

        function closePasswordChangeModal() {
            document.getElementById('password-change-modal').style.display = 'none';
        }

        async function saveNewPassword() {
            const currentPassword = document.getElementById('modal-current-password').value.trim();
            const newPassword = document.getElementById('modal-new-password').value.trim();
            const confirmPassword = document.getElementById('modal-confirm-password').value.trim();
            const errorDiv = document.getElementById('password-change-error');

            // Validation
            if (!currentPassword) {
                errorDiv.textContent = 'Please enter your current password';
                errorDiv.style.display = 'block';
                return;
            }

            if (!newPassword) {
                errorDiv.textContent = 'Please enter a new password';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long';
                errorDiv.style.display = 'block';
                return;
            }

            if (!confirmPassword) {
                errorDiv.textContent = 'Please confirm your new password';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (currentPassword === newPassword) {
                errorDiv.textContent = 'New password must be different from current password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    errorDiv.textContent = 'User not authenticated';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Re-authenticate user with current password (required by Firebase)
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );

                await user.reauthenticateWithCredential(credential);

                // Now update password
                await user.updatePassword(newPassword);

                closePasswordChangeModal();
                showSuccess('Password changed successfully! Please log in again with the new password.');

                // Sign out after 2 seconds to require new login
                setTimeout(() => {
                    firebase.auth().signOut().then(() => {
                        window.location.href = 'login.html';
                    });
                }, 2000);
            } catch (error) {
                console.error('Error changing password:', error);

                let errorMessage = 'Failed to change password: ';

                if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Session expired. Please log out and log back in';
                } else {
                    errorMessage += error.message;
                }

                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        }

        // Add Enter key support for password modal fields
        document.addEventListener('DOMContentLoaded', function() {
            const passwordFields = ['modal-new-password', 'modal-confirm-password'];

            passwordFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            saveNewPassword();
                        }
                    });
                }
            });
        });

        // Close modals on background click
        document.getElementById('parent-verification-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeParentVerification();
            }
        });

        document.getElementById('parental-control-panel').addEventListener('click', function(event) {
            if (event.target === this) {
                closeParentalControlPanel();
            }
        });

        document.getElementById('password-change-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closePasswordChangeModal();
            }
        });
    </script>
</body>
</html>
